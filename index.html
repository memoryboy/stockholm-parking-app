<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Stockholm Park</title>
<style>
/* ... same styles as before ... */
</style>
</head>
<body>
<div class="app-container">
  <header class="app-header">
    <h1 class="app-title">üÖøÔ∏è Stockholm Park</h1>
    <div class="current-time" id="currentTime">--:--</div>
    <div class="current-location" id="currentLocation">V√§ntar p√• position...</div>
  </header>
  <main class="app-main">
    <div class="gps-status">
      <div class="gps-indicator">
        <span class="gps-dot"></span><span id="gpsStatus">H√§mtar position...</span>
      </div>
    </div>
    <div id="errorContainer"></div>
    <div class="time-remaining hidden" id="timeRemaining">
      <div class="time-remaining-label">‚è∞ Till√•tet till</div>
      <div class="time-remaining-value" id="timeRemainingValue">--:--</div>
      <div class="time-remaining-subtext" id="timeRemainingSubtext">R√§knar...</div>
    </div>
    <div class="parking-status-container">
      <div class="parking-circle gray" id="parkingCircle">
        <div class="parking-icon" id="parkingIcon">‚è≥</div>
        <div class="parking-text" id="parkingText">LADDAR</div>
      </div>
    </div>
    <div class="parking-info hidden" id="parkingInfo">
      <div class="parking-rule" id="parkingRule"></div>
      <div class="parking-explanation" id="parkingExplanation"></div>
      <div class="parking-details">
        <div class="parking-detail-item">
          <span class="parking-detail-label">üìÖ Dagar:</span>
          <span class="parking-detail-value" id="detailDays">-</span>
        </div>
        <div class="parking-detail-item">
          <span class="parking-detail-label">üïê Tid:</span>
          <span class="parking-detail-value" id="detailTime">-</span>
        </div>
        <div class="parking-detail-item">
          <span class="parking-detail-label">üí∞ Taxa:</span>
          <span class="parking-detail-value" id="detailTaxa">-</span>
        </div>
        <div class="parking-detail-item">
          <span class="parking-detail-label">‚è±Ô∏è Max tid:</span>
          <span class="parking-detail-value" id="detailMaxTime">-</span>
        </div>
      </div>
    </div>
    <button class="refresh-btn" onclick="checkParking()">üîÑ Uppdatera position</button>
    <div class="coordinates" id="coordinates"></div>
  </main>
</div>
<script>
let parkingData = null;
window.addEventListener("load", () => {
  updateTime();
  setInterval(updateTime, 1000);
  checkParking();
});
function updateTime() {
  const now = new Date();
  document.getElementById("currentTime").textContent = now.toLocaleTimeString("sv-SE",{hour:"2-digit",minute:"2-digit"});
  if (parkingData && parkingData.endTime) {
    updateTimeRemaining(parkingData.endTime);
  }
}
async function checkParking() {
  showLoading();
  clearError();
  try {
    const position = await getCurrentPosition();
    const { latitude, longitude } = position.coords;
    document.getElementById("coordinates").textContent = `Lat: ${latitude.toFixed(6)}, Lng: ${longitude.toFixed(6)}`;
    document.getElementById("gpsStatus").textContent = "GPS Aktiv";
    await getAddress(latitude, longitude);
    const response = await fetch(`/api/parking?lat=${latitude}&lng=${longitude}&radius=100`);
    const data = await response.json();
    displayParkingStatus(data);
  } catch (err) {
    showError(err.message);
    showStatus("error");
  }
}
function getCurrentPosition() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject(new Error("Din webbl√§sare st√∂der inte geolokalisering"));
      return;
    }
    navigator.geolocation.getCurrentPosition(resolve, (error) => {
      reject(new Error(error.code === 1 ? "Till√•t plats√•tkomst" : "GPS ej tillg√§nglig"));
    }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
  });
}
function displayParkingStatus(data) {
  if (!data.features || data.features.length === 0) {
    showStatus("unknown");
    document.getElementById("parkingRule").textContent = "Inga parkeringsregler hittades";
    document.getElementById("parkingExplanation").textContent = "Kontrollera lokala skyltar";
    document.getElementById("parkingInfo").classList.remove("hidden");
    document.getElementById("timeRemaining").classList.add("hidden");
    return;
  }
  const feature = data.features[0];
  const parsed = feature.parsed || {};
  parkingData = { allowed: parsed.isCurrentlyAllowed !== false, endTime: parsed.timeUntil };
  showStatus(parkingData.allowed ? "allowed" : "forbidden");
  document.getElementById("parkingRule").textContent = parkingData.allowed ? "Parkering till√•ten h√§r" : "Parkering kan vara begr√§nsad";
  if (parsed.timeUntil) {
    document.getElementById("timeRemainingValue").textContent = parsed.timeUntil;
    updateTimeRemaining(parsed.timeUntil);
    document.getElementById("timeRemaining").classList.remove("hidden");
  } else {
    document.getElementById("timeRemaining").classList.add("hidden");
  }
  document.getElementById("parkingExplanation").textContent = `${data.features.length} parkeringsregel(er) funna.`;
  document.getElementById("detailDays").textContent = parsed.formattedDays || "Alla dagar";
  document.getElementById("detailTime").textContent = parsed.formattedTime || "Hela dygnet";
  document.getElementById("detailTaxa").textContent = parsed.taxa || "Ingen avgift";
  document.getElementById("detailMaxTime").textContent = parsed.maxTime || "Ingen begr√§nsning";
  document.getElementById("parkingInfo").classList.remove("hidden");
}
function updateTimeRemaining(endTimeStr) {
  if (!endTimeStr) return;
  const now = new Date();
  const [endHour, endMinute] = endTimeStr.split(":").map(Number);
  const endTime = new Date();
  endTime.setHours(endHour, endMinute, 0, 0);
  if (endTime < now) endTime.setDate(endTime.getDate() + 1);
  const diffMs = endTime - now;
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
  const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
  document.getElementById("timeRemainingSubtext").textContent =
    diffHours > 0 ? `${diffHours} timmar ${diffMinutes} minuter kvar` :
    diffMinutes > 0 ? `${diffMinutes} minuter kvar` : "Tiden g√•r snart ut!";
}
async function getAddress(lat, lng) {
  try {
    const response = await fetch(
      `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`,
      { headers: { "User-Agent": "StockholmParkApp/2.0", "Accept-Language": "sv" } }
    );
    const data = await response.json();
    if (data.address) {
      const street = data.address.road || data.address.neighbourhood || null;
      const city = data.address.city || data.address.municipality || "Stockholm";
      document.getElementById("currentLocation").textContent = street ? `${street}, ${city}` : city;
    }
  } catch {
    document.getElementById("currentLocation").textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
  }
}
function showStatus(status) {
  const circle = document.getElementById("parkingCircle");
  const icon = document.getElementById("parkingIcon");
  const text = document.getElementById("parkingText");
  circle.className = "parking-circle";
  if (status === "allowed") {
    circle.classList.add("green");
    icon.textContent = "‚úì";
    text.textContent = "TILL√ÖTET";
  } else if (status === "forbidden") {
    circle.classList.add("red");
    icon.textContent = "‚úï";
    text.textContent = "F√ñRBJUDET";
  } else {
    circle.classList.add("gray");
    icon.textContent = "?";
    text.textContent = "OK√ÑNT";
  }
}
function showLoading() {
  document.getElementById("parkingCircle").className = "parking-circle gray";
  document.getElementById("parkingIcon").textContent = "‚è≥";
  document.getElementById("parkingText").textContent = "LADDAR";
  document.getElementById("parkingInfo").classList.add("hidden");
  document.getElementById("timeRemaining").classList.add("hidden");
  document.getElementById("currentLocation").textContent = "H√§mtar adress...";
}
function showError(msg) {
  document.getElementById("errorContainer").innerHTML = `<div class=\"error\">‚ùå ${msg}</div>`;
}
function clearError() {
  document.getElementById("errorContainer").innerHTML = "";
}
</script>
</body>
</html>
