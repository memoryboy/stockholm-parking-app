
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stockholm Park ¬∑ v2.2</title>
  <style>
    :root{
      --bg1:#6536ff;--bg2:#8a2be2;--card:#ffffff;--ink:#111827;--muted:#6b7280;
      --ok1:#22c55e;--ok2:#16a34a;--err1:#ef4444;--err2:#dc2626;--warn1:#f59e0b;--warn2:#d97706;
      --brand1:#667eea;--brand2:#764ba2;--line:#e5e7eb;--sky:#e0f2fe;--skyline:#bae6fd;
    }
    *{box-sizing:border-box}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
    .app{width:100%;max-width:420px;background:var(--card);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden}
    header{background:linear-gradient(135deg,var(--brand1),var(--brand2));color:#fff;padding:22px;text-align:center;position:relative}
    header .badge{position:absolute;right:10px;top:10px;font-size:11px;background:rgba(255,255,255,.18);padding:4px 8px;border-radius:6px}
    h1{margin:0 0 6px 0;font-weight:800;letter-spacing:.2px}
    .when{opacity:.95;font-weight:600}
    .where{opacity:.9;font-size:13px}
    main{padding:22px}
    .status-pill{display:flex;align-items:center;gap:8px;justify-content:center;background:#eef2ff;color:#312e81;border-radius:999px;padding:8px 14px;font-weight:600}
    .circle{margin:28px auto;width:200px;height:200px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 12px 28px rgba(0,0,0,.18);color:#fff}
    .circle.ok{background:linear-gradient(135deg,var(--ok1),var(--ok2))}
    .circle.err{background:linear-gradient(135deg,var(--err1),var(--err2))}
    .circle.warn{background:linear-gradient(135deg,var(--warn1),var(--warn2))}
    .circle.neutral{background:linear-gradient(135deg,#9ca3af,#6b7280)}
    .circle .icon{font-size:56px;margin-bottom:6px}
    .circle .lbl{font-weight:800;letter-spacing:1px}
    .timebox{display:none;margin-bottom:18px;border-radius:14px;background:linear-gradient(135deg,var(--warn1),var(--warn2));color:#fff;padding:14px;text-align:center;box-shadow:0 8px 20px rgba(217,119,6,.35)}
    .timebox .ttl{font-size:12px;opacity:.9;letter-spacing:1px;text-transform:uppercase;margin-bottom:4px}
    .timebox .val{font-size:22px;font-weight:800}
    .timebox .sub{font-size:12px;opacity:.95;margin-top:4px}
    .card{background:#f9fafb;border-radius:14px;padding:16px;margin-bottom:18px}
    .card h3{margin:0 0 8px 0;font-size:16px}
    .kv{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--line);font-size:14px}
    .kv:last-child{border-bottom:none}
    .kv .k{color:#64748b;font-weight:600}
    .kv .v{color:#111827;font-weight:700}
    .btn{width:100%;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,var(--brand1),var(--brand2));color:#fff;font-weight:800;letter-spacing:.3px;cursor:pointer}
    .muted{margin-top:10px;text-align:center;color:#6b7280;font-size:12px}
    .errbox{display:none;background:#fee2e2;color:#991b1b;border-radius:10px;padding:12px;margin-bottom:12px}
    .debug{margin-top:12px;background:#f3f4f6;border:1px dashed #d1d5db;border-radius:10px;padding:10px;font:12px/1.4 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;white-space:pre-wrap;max-height:140px;overflow:auto}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="badge">v2.2</div>
      <h1>üÖøÔ∏è Stockholm Park</h1>
      <div class="when" id="now">--:--</div>
      <div class="where" id="where">H√§mtar adress‚Ä¶</div>
    </header>
    <main>
      <div class="status-pill" id="gpsPill"><span>üì°</span><span id="gpsTxt">H√§mtar position‚Ä¶</span></div>

      <div class="errbox" id="err"></div>

      <div class="timebox" id="timeBox">
        <div class="ttl">Till√•tet till</div>
        <div class="val" id="tillVal">--:--</div>
        <div class="sub" id="tillSub">‚Äî</div>
      </div>

      <div class="circle neutral" id="circle">
        <div class="icon" id="cIcon">‚è≥</div>
        <div class="lbl" id="cLbl">LADDAR</div>
      </div>

      <div class="card">
        <h3>Parkering</h3>
        <div class="kv"><div class="k">üìÖ Dagar</div><div class="v" id="vDays">‚Äî</div></div>
        <div class="kv"><div class="k">üïê Tid</div><div class="v" id="vTime">‚Äî</div></div>
        <div class="kv"><div class="k">üí∞ Taxa</div><div class="v" id="vTaxa">‚Äî</div></div>
        <div class="kv"><div class="k">‚è±Ô∏è Max tid</div><div class="v" id="vMax">‚Äî</div></div>
      </div>

      <button class="btn" onclick="run()">üîÑ Uppdatera</button>
      <div class="muted" id="coords">‚Äî</div>
      <div class="debug" id="dbg"></div>
    </main>
  </div>

  <script>
    const E = id => document.getElementById(id);
    const log = msg => { const d=E('dbg'); d.textContent += `\n${new Date().toLocaleTimeString()} ¬∑ ${msg}`; d.scrollTop=d.scrollHeight; };

    function setCircle(kind, text){
      const c = E('circle'); c.className='circle ' + (kind||'neutral');
      E('cLbl').textContent = text;
      E('cIcon').textContent = kind==='ok'?'‚úì': kind==='err'?'‚úï': kind==='warn'?'‚è∞':'‚è≥';
    }

    function showErr(msg){ const box=E('err'); box.style.display='block'; box.textContent = '‚ùå ' + msg; }
    function clearErr(){ const box=E('err'); box.style.display='none'; box.textContent=''; }

    function tickNow(){ E('now').textContent = new Date().toLocaleTimeString('sv-SE',{hour:'2-digit',minute:'2-digit'}); }
    setInterval(tickNow,1000); tickNow();

    async function run(){
      clearErr(); setCircle('neutral','LADDAR'); E('gpsTxt').textContent='H√§mtar position‚Ä¶'; E('timeBox').style.display='none';
      try{
        const pos = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:15000,maximumAge:0}));
        const {latitude:lat, longitude:lng} = pos.coords;
        E('coords').textContent = `Lat ${lat.toFixed(6)}, Lng ${lng.toFixed(6)}`;
        E('gpsTxt').textContent='GPS aktiv';
        log(`GPS ${lat.toFixed(5)}, ${lng.toFixed(5)}`);

        // reverse geocode (best effort)
        try{
          const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`,{headers:{'User-Agent':'StockholmPark/2.2','Accept-Language':'sv'}});
          const j = await r.json();
          const a = j.address||{}; const street=a.road||a.pedestrian||a.footway||a.neighbourhood||''; const city=a.city||a.town||a.municipality||'Stockholm';
          E('where').textContent = street? `${street}, ${city}` : city;
        }catch{ E('where').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`; }

        // call backend
        const resp = await fetch(`/api/parking?lat=${lat}&lng=${lng}&radius=120`);
        if(!resp.ok){ throw new Error('API-fel ' + resp.status); }
        const data = await resp.json();
        log(`API features: ${data.features?data.features.length:0}`);
        E('dbg').textContent += `\nSample: ` + JSON.stringify(data.features?.[0]?.properties||{},null,0).slice(0,240);

        if(!data.features || !data.features.length){
          setCircle('warn','OK√ÑNT'); E('vDays').textContent='‚Äî'; E('vTime').textContent='‚Äî'; E('vTaxa').textContent='‚Äî'; E('vMax').textContent='‚Äî'; return; }

        // choose best rule: prefer ones with explicit times or taxa
        const scored = data.features.map(f=>{
          const p=f.properties||{}; const score=(p.TID_TILL?3:0)+(p.TID_FRAN?2:0)+(p.TAXA?1:0); return {f,score};
        }).sort((a,b)=>b.score-a.score);
        const best = (scored[0]||{}).f || data.features[0];
        const props = best.properties||{}; const parsed = best.parsed||{};

        const days = parsed.formattedDays || props.DAGAR || '‚Äî';
        const timeFrom = props.TID_FRAN || '';
        const timeTill = props.TID_TILL || '';
        const timeStr = parsed.formattedTime || (timeFrom||timeTill? `${timeFrom||'‚Äî'} - ${timeTill||'‚Äî'}` : 'Hela dygnet');
        const taxa = parsed.taxa || (props.TAXA? `Taxa ${props.TAXA}`:'Ingen avgift');
        const maxT = parsed.maxTime || props.MAX_TID || 'Ingen begr√§nsning';

        // display values
        E('vDays').textContent = days; E('vTime').textContent = timeStr; E('vTaxa').textContent = taxa; E('vMax').textContent = maxT;

        // allowed / time left
        const now = new Date();
        let allowed = parsed.isCurrentlyAllowed; if(allowed===undefined){
          if(timeFrom && timeTill){ const cur=now.getHours()*100+now.getMinutes(); const s=parseInt(timeFrom.replace(':','')); const e=parseInt(timeTill.replace(':','')); allowed = (cur>=s && cur<e); } else { allowed=true; }
        }
        if(allowed){ setCircle('ok','TILL√ÖTET'); } else { setCircle('err','F√ñRBJUDET'); }

        if(timeTill){
          E('timeBox').style.display='block';
          E('tillVal').textContent = timeTill;
          // countdown
          const end = new Date(); const [hh,mm]=timeTill.split(':').map(Number); end.setHours(hh,mm,0,0); if(end<now) end.setDate(end.getDate()+1);
          const ms=end-now; const h=Math.floor(ms/3.6e6); const m=Math.floor((ms%3.6e6)/6e4); E('tillSub').textContent = (h>0?`${h} h `:'')+`${m} min kvar`;
        }
      }catch(e){ showErr(e.message||'N√•got gick fel'); setCircle('err','FEL'); log('ERROR '+e); }
    }

    // auto-run
    if('geolocation' in navigator){ run(); } else { showErr('Din webbl√§sare st√∂der inte plats'); }
  </script>
</body>
</html>
